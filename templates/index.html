<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

    <title>Dashboard Saham IDX</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            padding: 20px;
        }
        select, button {
            padding: 8px;
            font-size: 14px;
            margin-right: 8px;
        }
        .card {
            background: #020617;
            padding: 16px;
            margin-top: 16px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        th, td {
            border-bottom: 1px solid #1e293b;
            padding: 6px;
            text-align: right;
        }
        th {
            text-align: center;
        }
    </style>
</head>
<body>

<h2>ðŸ“Š Dashboard Saham Indonesia</h2>

<select id="stockSelect">
    <option value="">-- Pilih Saham --</option>
    <option value="BBCA.JK">BBCA</option>
    <option value="TLKM.JK">TLKM</option>
    <option value="BMRI.JK">BMRI</option>
    <option value="ASII.JK">ASII</option>
    <option value="BRIS.JK">BRIS</option>
</select>

<select id="stockInterval">
    <option value="1d">Harian</option>
    <option value="1h">Per Jam</option>
    <option value="15m">15 Menit</option>
    <option value="5m">5 Menit</option>
</select>

<button onclick="loadStock()">Load</button>

<div id="result" class="card" style="display:none;">

    <canvas id="stockChart" height="120"></canvas>

    <h3 id="symbol"></h3>
    <p>
        ðŸ’° Last: <b id="last"></b> |
        ðŸ“ˆ High: <b id="high"></b> |
        ðŸ“‰ Low: <b id="low"></b> |
        ðŸ“Š Volume: <b id="volume"></b>
    </p>

    <table>
        <thead>
            <tr>
                <th>Waktu</th>
                <th>Open</th>
                <th>High</th>
                <th>Low</th>
                <th>Close</th>
                <th>Volume</th>
            </tr>
        </thead>
        <tbody id="history"></tbody>
    </table>
</div>

<script>
let chart;
let autoRefresh;

async function loadStock() {
    const symbol = document.getElementById("stockSelect").value;
    const interval = document.getElementById("stockInterval").value || "15m";
    if (!symbol) return alert("Pilih saham dulu!");

    const res = await fetch(`/api/stock?symbol=${symbol}&interval=${interval}`);
    const data = await res.json();

    if (data.error) {
        alert(data.error);
        return;
    }

    document.getElementById("result").style.display = "block";
    document.getElementById("symbol").innerText = data.symbol;
    document.getElementById("last").innerText = data.last_price;
    document.getElementById("high").innerText = data.high;
    document.getElementById("low").innerText = data.low;
    document.getElementById("volume").innerText = data.volume.toLocaleString();

    renderChart(data.history);
    renderTable(data.history);

    // auto refresh tiap 1 menit
    clearInterval(autoRefresh);
    autoRefresh = setInterval(loadStock, 60000);
}

function renderChart(history) {
    const ctx = document.getElementById("stockChart");

    const candles = history.map(h => ({
        x: new Date(h.time),
        o: h.open,
        h: h.high,
        l: h.low,
        c: h.close
    }));

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "candlestick",
        data: {
            datasets: [{
                label: "Harga Saham",
                data: candles,
                color: {
                    up: "#22c55e",
                    down: "#ef4444",
                    unchanged: "#e5e7eb"
                }
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: "time",
                    time: { unit: "minute" },
                    ticks: { color: "#e5e7eb" }
                },
                y: {
                    ticks: { color: "#e5e7eb" }
                }
            }
        }
    });
}

function renderTable(history) {
    const tbody = document.getElementById("history");
    tbody.innerHTML = "";

    history.slice().reverse().forEach(row => {
        tbody.innerHTML += `
            <tr>
                <td style="text-align:center">${row.time}</td>
                <td>${row.open}</td>
                <td>${row.high}</td>
                <td>${row.low}</td>
                <td>${row.close}</td>
                <td>${row.volume.toLocaleString()}</td>
            </tr>
        `;
    });
}
</script>


</body>
</html>
